zabbix_export:
  version: '7.2'
  template_groups:
  - uuid: 748ad4d098d447d492bb935c907f652f
    name: Templates/Databases
  templates:
  - uuid: 21cca24cec1d40cdb0c2999aa6ac3037
    template: PostgreSQL by Zabbix agent 2 active
    name: PostgreSQL by Zabbix agent 2 active
    description: |
      This template is designed for the deployment of PostgreSQL monitoring by Zabbix via Zabbix agent 2 and uses a loadable plugin to run SQL queries.

      Setup:

      1. Deploy Zabbix agent 2 with the PostgreSQL plugin. Starting with Zabbix versions 6.0.10 / 6.2.4 / 6.4 PostgreSQL metrics are moved to a loadable plugin and require installation of a separate package or compilation of the plugin from sources (https://www.zabbix.com/documentation/7.2/manual/extensions/plugins/build).

      2. Create the PostgreSQL user for monitoring (`<password>` at your discretion) and inherit permissions from the default role `pg_monitor`:
      CREATE USER zbx_monitor WITH PASSWORD '<PASSWORD>' INHERIT;
      GRANT pg_monitor TO zbx_monitor;

      3. Edit the `pg_hba.conf` configuration file to allow connections for the user `zbx_monitor`. You can check the PostgreSQL documentation for examples (https://www.postgresql.org/docs/current/auth-pg-hba-conf.html).

      4. Set the connection string for the PostgreSQL instance in the `{$PG.CONNSTRING.AGENT2}` macro as URI, such as `<protocol(host:port)>`, or specify the named session - `<sessionname>`.

      Note: if you want to use SSL/TLS encryption to protect communications with the remote PostgreSQL instance, a named session must be used. In that case, the instance URI should be specified in the `Plugins.PostgreSQL.Sessions.*.Uri` parameter in the PostgreSQL plugin configuration files alongside all the encryption parameters (type, cerfiticate/key filepaths if needed etc.).

      You can check the PostgreSQL plugin documentation (https://git.zabbix.com/projects/AP/repos/postgresql/browse?at=refs%2Fheads%2Frelease%2F7.2) for details about agent plugin parameters and named sessions.

      Also, it is assumed that you set up the PostgreSQL instance to work in the desired encryption mode. Check the PostgreSQL documentation (https://www.postgresql.org/docs/current/ssl-tcp.html) for details.

      Note that plugin TLS certificate validation relies on checking the Subject Alternative Names (SAN) instead of the Common Name (CN), check the cryptography package documentation (https://pkg.go.dev/crypto/x509) for details.

      For example, to enable required encryption in transport mode without identity checks you could create the file `/etc/zabbix/zabbix_agent2.d/postgresql_myconn.conf` with the following configuration for the named session `myconn` (replace `<instanceip>` with the address of the PostgreSQL instance):
      Plugins.PostgreSQL.Sessions.myconn.Uri=tcp://<instanceip>:5432
      Plugins.PostgreSQL.Sessions.myconn.TLSConnect=required

      Then set the `{$PG.CONNSTRING.AGENT2}` macro to `myconn` to use this named session.

      5. Set the password that you specified in step 2 in the macro `{$PG.PASSWORD}`.

      You can discuss this template or leave feedback on our forum https://www.zabbix.com/forum/zabbix-suggestions-and-feedback/384190-%C2%A0discussion-thread-for-official-zabbix-template-db-postgresql

      Generated by official Zabbix template tool "Templator"
    vendor:
      name: Zabbix
      version: 7.2-1
    groups:
    - name: Templates/Databases
    tags:
    - tag: class
      value: database
    - tag: target
      value: postgresql
    macros:
    - macro: '{$PG.CONFLICTS.MAX.WARN}'
      value: '0'
      description: Maximum number of recovery conflicts for trigger expression.
    - macro: '{$PG.CONNSTRING.AGENT2}'
      value: tcp://localhost:5432
      description: URI or named session of the PostgreSQL instance.
    - macro: '{$PG.CONN_TOTAL_PCT.MAX.WARN}'
      value: '90'
      description: Maximum percentage of current connections for trigger expression.
    - macro: '{$PG.DATABASE}'
      value: postgres
      description: Default PostgreSQL database for the connection.
    - macro: '{$PG.DEADLOCKS.MAX.WARN}'
      value: '0'
      description: Maximum number of detected deadlocks for trigger expression.
    - macro: '{$PG.LLD.FILTER.APPLICATION}'
      value: .+
      description: Filter of discoverable applications.
    - macro: '{$PG.LLD.FILTER.DBNAME}'
      value: .+
      description: Filter of discoverable databases.
    - macro: '{$PG.PASSWORD}'
      value: <Put the password here>
      description: PostgreSQL user password.
    - macro: '{$PG.QUERY_ETIME.MAX.WARN}'
      value: '30'
      description: Execution time limit for count of slow queries.
    - macro: '{$PG.SLOW_QUERIES.MAX.WARN}'
      value: '5'
      description: Slow queries count threshold for a trigger.
    - macro: '{$PG.USER}'
      value: zbx_monitor
      description: PostgreSQL username.
